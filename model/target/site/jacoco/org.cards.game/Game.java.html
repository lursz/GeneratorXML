<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">poker-model</a> &gt; <a href="index.source.html" class="el_package">org.cards.game</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package org.cards.game;

import org.cards.object.*;
import org.cards.player.*;
import org.cards.exceptions.*;

import javax.print.attribute.standard.PrintQuality;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.SocketChannel;
import java.util.*;


public class Game {
    //Object of the game
    private Deck deck_;

<span class="fc" id="L18">    public static final ArrayList&lt;Player&gt; players_ = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L19">    public static final Map&lt;SelectionKey, Player&gt; playerMap = new HashMap&lt;&gt;();</span>

    private int pot_;



<span class="fc" id="L25">    private int gameState = 0;</span>
    // 0 - waiting for players
    // 1 - first round bets
    // 2 - waiting for cards to change
    // 3 - second round bets
    // 4 - after showdown
    // 5 - game over

<span class="fc" id="L33">    private int currentPlayerIndex = 0;</span>
<span class="fc" id="L34">    private int currentBet = 0;</span>
    private int numberOfPlayers;
    //Ready?
    private int numberOfReadyPlayers;
    //Ready?
    private boolean initialized_;




    public static class Pair {
        public String answer;
        public boolean toAll;

<span class="fc" id="L48">        Pair(String answer, boolean toAll) {</span>
<span class="fc" id="L49">            this.answer = answer;</span>
<span class="fc" id="L50">            this.toAll = toAll;</span>
<span class="fc" id="L51">        }</span>

    }


    /* -------------------------------------------------------------------------- */
    /*                                 Constructor                                */
    /* -------------------------------------------------------------------------- */
<span class="fc" id="L59">    public Game() {</span>
<span class="fc" id="L60">        this.deck_ = new Deck();</span>
<span class="fc" id="L61">        initialized_ = false;</span>
<span class="fc" id="L62">        numberOfPlayers = 0;</span>
<span class="fc" id="L63">    }</span>

    void setPot_(int pot_) {
<span class="fc" id="L66">        this.pot_ = pot_;</span>
<span class="fc" id="L67">    }</span>
    int getPot_() {
<span class="fc" id="L69">        return this.pot_;</span>
    }
    int getNumberOfPlayers() {
<span class="fc" id="L72">        return numberOfPlayers;</span>
    }

    public void addNumberOfPlayers() {
<span class="fc" id="L76">        numberOfPlayers++;</span>
<span class="fc" id="L77">    }</span>

    /* -------------------------------------------------------------------------- */
    /*                            Master Game Function                            */
    /* -------------------------------------------------------------------------- */

    /**
     * Change the current player to next player
     */
    public void nextPlayer() {
        do {
<span class="nc" id="L88">            currentPlayerIndex++;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (currentPlayerIndex == numberOfPlayers) {</span>
<span class="nc" id="L90">                currentPlayerIndex = 0;</span>
            }
<span class="nc bnc" id="L92" title="All 2 branches missed.">        } while (players_.get(currentPlayerIndex).isFolded_());</span>
<span class="nc" id="L93">    }</span>

    /**
     * Function communicating with the server
     * @param command
     * @param player
     * @return
     */
    public Pair receiveCommands(String command, Player player) {
<span class="fc" id="L102">        String[] commandParts = command.split(&quot; &quot;);</span>
<span class="pc bpc" id="L103" title="7 of 12 branches missed.">        switch (commandParts[0]) {</span>
            //List of commands
            case &quot;/help&quot;: {
<span class="nc" id="L106">                return new Pair(&quot;help - show the list of commands\n &quot; +</span>
                        &quot;/ready - start the game\n &quot; +
                        &quot;&lt;CARDS&gt;\n &quot; +
                        &quot;/hand - show cards and balance and pot\n &quot; +
                        &quot;/check - continue without placing a wager \n &quot; +
                        &quot;/call - match the wager \n &quot; +
                        &quot;/raise &lt;amount&gt; - raise the wager \n &quot; +
                        &quot;/fold - withdraw from the round\n &quot; +
                        &quot;/exchange - exchange your cards during exchange phase. Syntax is: /exchange 1,2,5 or '-' for no exchange.\n &quot; +
                        &quot;&lt;GAME&gt;\n &quot; +
                        &quot;/exit - exit the game\n&quot;, false);
            }
            //Set username
            case &quot;/usr&quot;: {
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (gameState != 0) {</span>
<span class="nc" id="L121">                    return new Pair(&quot;You can't change your username now&quot;, false);</span>
                }

<span class="nc bnc" id="L124" title="All 2 branches missed.">                if (commandParts.length == 2) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                    if (initialized_) {</span>
<span class="nc" id="L126">                        return new Pair(&quot;Game already started&quot;, false);</span>
                    } else {
<span class="nc" id="L128">                        player.setName_(commandParts[1]);</span>
<span class="nc" id="L129">                        System.out.println(&quot;Player &quot; + player.getName_() + &quot; joined the game.&quot;);</span>
<span class="nc" id="L130">                        return new Pair(&quot;Username set to &quot; + commandParts[1], false);</span>
                    }
                } else {
<span class="nc" id="L133">                    return new Pair(&quot;Wrong command&quot;, false);</span>
                }

            }
            case &quot;/ready&quot;: {
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">                if (gameState != 0) {</span>
<span class="nc" id="L139">                    return new Pair(&quot;You cannot start the game now&quot;, false);</span>
                }

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">                if (initialized_) {</span>
<span class="nc" id="L143">                    return new Pair(&quot;Game already started&quot;, false);</span>
                } else {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">                    if (player.getName_() == null) {</span>
<span class="nc" id="L146">                        return new Pair(&quot;Set username first&quot;, false);</span>
                    } else {
<span class="fc" id="L148">                        numberOfReadyPlayers++;</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">                        if (numberOfReadyPlayers == numberOfPlayers) {</span>
<span class="nc" id="L150">                            initialized_ = true;</span>
<span class="nc" id="L151">                            System.out.println(&quot;Game has begun&quot;);</span>
<span class="nc" id="L152">                            startGame();</span>
<span class="nc" id="L153">                            return new Pair(&quot;Game is starting now, use /hand to view cards.&quot;, true);</span>
                        } else {
<span class="fc" id="L155">                            return new Pair(&quot;Waiting for other players&quot;, false);</span>
                        }
                    }
                }

            }
            case &quot;/hand&quot;: {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">                if (gameState == 0) {</span>
<span class="fc" id="L163">                    return new Pair(&quot;Game hasn't started yet&quot;, false);</span>
                }
<span class="nc bnc" id="L165" title="All 2 branches missed.">                if (gameState == 5) {</span>
<span class="nc" id="L166">                    return new Pair(&quot;Game is over&quot;, false);</span>
                }
<span class="nc bnc" id="L168" title="All 2 branches missed.">                if (player.isFolded_())</span>
<span class="nc" id="L169">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (initialized_) {</span>
                    //show hand and balance and pot
<span class="nc" id="L172">                    return new Pair(&quot;Your cards: &quot; + player.getHand_().toString() + &quot;\n&quot; +</span>
<span class="nc" id="L173">                            &quot;Your balance: &quot; + player.getBalance_() + &quot;\n&quot; +</span>
                            &quot;Pot: &quot; + pot_, false);

                } else {
<span class="nc" id="L177">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            //Check - to not bet without folding.
            case &quot;/check&quot;: {

<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                if (gameState == 0) {</span>
<span class="fc" id="L185">                    return new Pair(&quot;Game hasn't started yet&quot;, false);</span>
                }
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (gameState == 2) {</span>
<span class="nc" id="L188">                    return new Pair(&quot;You can't check now&quot;, false);</span>
                }
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (gameState == 5) {</span>
<span class="nc" id="L191">                    return new Pair(&quot;Game is over&quot;, false);</span>
                }
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (player.isFolded_()) {</span>
<span class="nc" id="L194">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>
                }
<span class="nc bnc" id="L196" title="All 2 branches missed.">                if (currentPlayerIndex != players_.indexOf(player)) {</span>
<span class="nc" id="L197">                    return new Pair(&quot;It's not your turn&quot;, false);</span>
                }
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (currentBet &gt; 0) {</span>
<span class="nc" id="L200">                    return new Pair(&quot;You can't check now, the bet is greater than 0&quot;, false);</span>
                }
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc" id="L203">                    player.setBet_(0);</span>
<span class="nc" id="L204">                    currentBet = 0;</span>
<span class="nc" id="L205">                    nextPlayer();</span>
<span class="nc" id="L206">                    String answer = &quot;--&quot;+player.getName_() + &quot; checked--&quot;;</span>
<span class="nc" id="L207">                    endFirstRoundBets();</span>
<span class="nc" id="L208">                    endOfSecondRoundBets();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                    if (gameState == 4) {</span>
<span class="nc" id="L210">                        return new Pair(answer + &quot;\nShowdown time! Are you ready? Type /showdown to see the results appear on everyone's screen.&quot;, true);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                    } else if (gameState == 2) {</span>
<span class="nc" id="L212">                        return new Pair(answer +&quot;\nIt's time to exchange your cards using /exchange &lt;number, [number]&gt;. Then proceed with next betting round.&quot;, true);</span>
                    }
<span class="nc" id="L214">                    return new Pair(answer, true);</span>
                } else {
<span class="nc" id="L216">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            case &quot;/bet&quot;: {
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (gameState == 0) {</span>
<span class="nc" id="L222">                    return new Pair(&quot;Game hasn't started yet&quot;, false);</span>
                }
<span class="nc bnc" id="L224" title="All 2 branches missed.">                if (gameState == 2) {</span>
<span class="nc" id="L225">                    return new Pair(&quot;You can't bet now&quot;, false);</span>
                }
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (gameState == 5) {</span>
<span class="nc" id="L228">                    return new Pair(&quot;Game is over&quot;, false);</span>
                }
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (player.isFolded_())</span>
<span class="nc" id="L231">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>


<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (currentPlayerIndex != players_.indexOf(player)) {</span>
<span class="nc" id="L235">                    return new Pair(&quot;It's not your turn&quot;, false);</span>
                }
<span class="nc bnc" id="L237" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    if (commandParts.length == 2) {</span>
                        try {
<span class="nc" id="L240">                            int bet = Integer.parseInt(commandParts[1]);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                            if (bet &lt; 0) {</span>
<span class="nc" id="L242">                                return new Pair(&quot;Bet must be positive&quot;, false);</span>
                            }
<span class="nc bnc" id="L244" title="All 2 branches missed.">                            if (bet &lt; currentBet) {</span>
<span class="nc" id="L245">                                return new Pair(&quot;Bet must be greater than current bet&quot;, false);</span>
                            }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                            if (bet &gt; player.getBalance_()) {</span>
<span class="nc" id="L248">                                return new Pair(&quot;Not enough money&quot;, false);</span>
                            } else {
<span class="nc bnc" id="L250" title="All 2 branches missed.">                                if(player.getBet_() == -1) {</span>
<span class="nc" id="L251">                                    player.setBet_(0);</span>
                                }
<span class="nc" id="L253">                                pot_ += bet-player.getBet_();</span>
<span class="nc" id="L254">                                player.setBalance_(player.getBalance_()-(bet-player.getBet_()));</span>
<span class="nc" id="L255">                                player.setBet(bet);</span>

<span class="nc" id="L257">                                currentBet = bet;</span>
<span class="nc" id="L258">                                String answer = &quot;--&quot;+player.getName_() + &quot; bet &quot; + bet + &quot;--&quot;;</span>
<span class="nc" id="L259">                                nextPlayer();</span>
<span class="nc" id="L260">                                endFirstRoundBets();</span>
<span class="nc" id="L261">                                endOfSecondRoundBets();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                                if (gameState == 4) {</span>
<span class="nc" id="L263">                                    return new Pair(answer + &quot;\nShowdown time! Are you ready? Type /showdown to see the results appear on everyone's screen.&quot;, true);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                                } else if (gameState == 2) {</span>
<span class="nc" id="L265">                                    return new Pair(answer +&quot;\nIt's time to exchange your cards using /exchange &lt;number,[number]&gt; (no comma). Then proceed with next betting round.&quot;, true);</span>
                                }
<span class="nc" id="L267">                                return new Pair(answer, true);</span>
                            }
<span class="nc" id="L269">                        } catch (NumberFormatException e) {</span>
<span class="nc" id="L270">                            return new Pair(&quot;Wrong command&quot;, false);</span>
<span class="nc" id="L271">                        } catch (BalanceTooLow e) {</span>
<span class="nc" id="L272">                            throw new RuntimeException(e);</span>
                        }
                    } else {
<span class="nc" id="L275">                        return new Pair(&quot;Wrong command&quot;, false);</span>
                    }
                } else {
<span class="nc" id="L278">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            //Call - a bet that is the equal amount to the bet made prior.
            case &quot;/call&quot;: {
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">                if (gameState == 0) {</span>
<span class="fc" id="L285">                    return new Pair(&quot;Game hasn't started yet&quot;, false);</span>
                }
<span class="nc bnc" id="L287" title="All 2 branches missed.">                if (gameState == 2) {</span>
<span class="nc" id="L288">                    return new Pair(&quot;You can't call now&quot;, false);</span>
                }
<span class="nc bnc" id="L290" title="All 2 branches missed.">                if (gameState == 5) {</span>
<span class="nc" id="L291">                    return new Pair(&quot;Game is over&quot;, false);</span>
                }

<span class="nc bnc" id="L294" title="All 2 branches missed.">                if (player.isFolded_())</span>
<span class="nc" id="L295">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">                if (currentPlayerIndex != players_.indexOf(player)) {</span>
<span class="nc" id="L298">                    return new Pair(&quot;It's not your turn&quot;, false);</span>
                }

<span class="nc bnc" id="L301" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                    if (commandParts.length == 1) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                        if(player.getBet_() == -1) {</span>
<span class="nc" id="L304">                            player.setBet_(0);</span>
                        }
<span class="nc" id="L306">                        pot_ += currentBet-player.getBet_();</span>
<span class="nc" id="L307">                        player.setBalance_(player.getBalance_()-(currentBet-player.getBet_()));</span>
<span class="nc" id="L308">                        player.setBet_(currentBet);</span>
<span class="nc" id="L309">                        String answer = &quot;--&quot;+player.getName_() + &quot; called. The current bet is: &quot;+currentBet+&quot; --&quot;;</span>
<span class="nc" id="L310">                        nextPlayer();</span>
<span class="nc" id="L311">                        endFirstRoundBets();</span>
<span class="nc" id="L312">                        endOfSecondRoundBets();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                        if (gameState == 4) {</span>
<span class="nc" id="L314">                            return new Pair(answer + &quot;\nShowdown time! Are you ready? Type /showdown to see the results appear on everyone's screen.&quot;, true);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                        } else if (gameState == 2) {</span>
<span class="nc" id="L316">                            return new Pair(answer +&quot;\nIt's time to exchange your cards using /exchange &lt;number, [number]&gt;. Then proceed with next betting round.&quot;, true);</span>
                        }
<span class="nc" id="L318">                        return new Pair(answer, true);</span>
                    } else {
<span class="nc" id="L320">                        return new Pair(&quot;Wrong command&quot;, false);</span>
                    }
                } else {
<span class="nc" id="L323">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            case &quot;/raise&quot;: {
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">                if (gameState == 0) {</span>
<span class="fc" id="L329">                    return new Pair(&quot;Game hasn't started yet&quot;, false);</span>
                }
<span class="nc bnc" id="L331" title="All 2 branches missed.">                if (gameState == 2) {</span>
<span class="nc" id="L332">                    return new Pair(&quot;You can't raise now&quot;, false);</span>
                }
<span class="nc bnc" id="L334" title="All 2 branches missed.">                if (gameState == 5) {</span>
<span class="nc" id="L335">                    return new Pair(&quot;Game is over&quot;, false);</span>
                }

<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (player.isFolded_())</span>
<span class="nc" id="L339">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>

<span class="nc bnc" id="L341" title="All 2 branches missed.">                if (currentPlayerIndex != players_.indexOf(player)) {</span>
<span class="nc" id="L342">                    return new Pair(&quot;It's not your turn&quot;, false);</span>
                }
<span class="nc bnc" id="L344" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                    if (commandParts.length == 2) {</span>

<span class="nc" id="L347">                        int bet = Integer.parseInt(commandParts[1]);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                        if (bet &lt; 0) {</span>
<span class="nc" id="L349">                            return new Pair(&quot;Bet must be positive&quot;, false);</span>
                        }
<span class="nc bnc" id="L351" title="All 2 branches missed.">                        if (bet &gt; player.getBalance_()) {</span>
<span class="nc" id="L352">                            return new Pair(&quot;Not enough money&quot;, false);</span>
                        } else {
<span class="nc bnc" id="L354" title="All 2 branches missed.">                            if(player.getBet_() == -1) {</span>
<span class="nc" id="L355">                                player.setBet_(0);</span>
                            }
<span class="nc" id="L357">                            currentBet += bet;</span>
<span class="nc" id="L358">                            pot_ += bet;</span>
<span class="nc" id="L359">                            player.setBalance_(player.getBalance_()-bet);</span>
<span class="nc" id="L360">                            player.setBet_(currentBet);</span>
<span class="nc" id="L361">                            String answer = &quot;--&quot;+player.getName_() + &quot; raised to: &quot; + currentBet + &quot;--&quot;;</span>
<span class="nc" id="L362">                            nextPlayer();</span>
<span class="nc" id="L363">                            endFirstRoundBets();</span>
<span class="nc" id="L364">                            endOfSecondRoundBets();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                            if (gameState == 4) {</span>
<span class="nc" id="L366">                                return new Pair(answer + &quot;\nShowdown time! Are you ready? Type /showdown to see the results appear on everyone's screen.&quot;, true);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                            } else if (gameState == 2) {</span>
<span class="nc" id="L368">                                return new Pair(answer +&quot;\nIt's time to exchange your cards using /exchange &lt;number, [number]&gt;. Then proceed with next betting round.&quot;, true);</span>
                            }
<span class="nc" id="L370">                            return new Pair(answer, true);</span>
                        }

                    } else {
<span class="nc" id="L374">                        return new Pair(&quot;Wrong command&quot;, false);</span>
                    }
                } else {
<span class="nc" id="L377">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            case &quot;/fold&quot;: {

<span class="nc bnc" id="L383" title="All 2 branches missed.">                if (currentPlayerIndex != players_.indexOf(player)) {</span>
<span class="nc" id="L384">                    return new Pair(&quot;It's not your turn&quot;, false);</span>
                }
<span class="nc bnc" id="L386" title="All 2 branches missed.">                if (player.isFolded_())</span>
<span class="nc" id="L387">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc" id="L389">                    player.incrementRoundsPlayed();</span>
<span class="nc" id="L390">                    player.fold();</span>
<span class="nc" id="L391">                    endOfSecondRoundBets();</span>
<span class="nc" id="L392">                    return new Pair(&quot;Player &quot; + player.getName_() + &quot;folded. He is out of the game.&quot;, true);</span>
                } else {
<span class="nc" id="L394">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            case &quot;/exchange&quot;: {
<span class="nc bnc" id="L399" title="All 2 branches missed.">                if (player.isFolded_())</span>
<span class="nc" id="L400">                    return new Pair(&quot;You folded, wait for next round&quot;, false);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (gameState == 0) {</span>
<span class="nc" id="L402">                    return new Pair(&quot;Game hasn't started yet&quot;, false);</span>
                }

<span class="nc bnc" id="L405" title="All 6 branches missed.">                if (gameState == 1 || gameState == 3 || gameState == 4) {</span>
<span class="nc" id="L406">                    return new Pair(&quot;Can't exchange in this part of the game.&quot;, false);</span>
                }
<span class="nc bnc" id="L408" title="All 2 branches missed.">                if (gameState == 5) {</span>
<span class="nc" id="L409">                    return new Pair(&quot;Game is over&quot;, false);</span>
                }
<span class="nc bnc" id="L411" title="All 2 branches missed.">                if (player.wereTheHandsChanged_) {</span>
<span class="nc" id="L412">                    return new Pair(&quot;You already changed your cards&quot;, false);</span>
                }
<span class="nc bnc" id="L414" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                    if (commandParts.length == 2) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                        if (commandParts[1].equals(&quot;-&quot;)) {</span>
<span class="nc" id="L417">                            player.wereTheHandsChanged_ = true;</span>
<span class="nc" id="L418">                            endOfStateWaitingForCardsChangePhase();</span>
<span class="nc" id="L419">                            return new Pair(&quot;No cards were exchanged&quot;, false);</span>
                        }
<span class="nc" id="L421">                        String[] splittedCards = commandParts[1].split(&quot;,&quot;);</span>
<span class="nc" id="L422">                        int[] indexOfCardsToExchange = new int[splittedCards.length];</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">                        for (int i = 0; i &lt; splittedCards.length; i++) {</span>
<span class="nc" id="L424">                            indexOfCardsToExchange[i] = Integer.parseInt(splittedCards[i]);</span>
                        }

<span class="nc" id="L427">                        player.getHand_().exchangeCards(indexOfCardsToExchange, deck_);</span>
<span class="nc" id="L428">                        player.wereTheHandsChanged_ = true;</span>
<span class="nc" id="L429">                        endOfStateWaitingForCardsChangePhase();</span>


<span class="nc" id="L432">                        return new Pair(&quot;Cards exchanged.\nYour cards: &quot; + player.getHand_().toString() + &quot;\n&quot; + &quot;Your balance: &quot; + player.getBalance_() + &quot;\n&quot; + &quot;Pot: &quot; + pot_, false);</span>

                    } else {
<span class="nc" id="L435">                        return new Pair(&quot;Wrong command&quot;, false);</span>
                    }
                } else {
<span class="nc" id="L438">                    return new Pair(&quot;Game not started&quot;, false);</span>
                }

            }
            case &quot;/showdown&quot;: {
<span class="nc bnc" id="L443" title="All 2 branches missed.">                if (initialized_) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">                    if (gameState == 4) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">                        if (commandParts.length == 1) {</span>
<span class="nc" id="L446">                            String answer = &quot;&quot;;</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                            for (Player player_i : playerMap.values()) {</span>
<span class="nc" id="L448">                                answer += player_i.getName_() + &quot;: &quot; + player_i.getHand_().toString() + &quot;\n&quot;;</span>
<span class="nc" id="L449">                            }</span>
                            //show nickname of the winner
<span class="nc" id="L451">                            Player winner = calculateRoundWinner();</span>
<span class="nc" id="L452">                            answer += &quot;Winner: &quot; + winner.getName_() + &quot;\n&quot;;</span>
<span class="nc" id="L453">                            endOfStateGameOverStartNextRound();</span>
<span class="nc" id="L454">                            return new Pair(answer, true);</span>
                        } else {
<span class="nc" id="L456">                            return new Pair(&quot;Wrong command&quot;, false);</span>
                        }
                    } else {
<span class="nc" id="L459">                        return new Pair(&quot;Can't use the command&quot;, false);</span>
                    }
                }
<span class="nc" id="L462">                return new Pair(&quot;Can't use the command&quot;, false);</span>

            }

            default:
<span class="nc" id="L467">                return new Pair(&quot;Wrong command&quot;, false);</span>

        }

    }
    /* -------------------------------------------------------------------------- */
    /*                                   Methods                                  */
    /* -------------------------------------------------------------------------- */

    /**
     * Function to send a message to client without a request
     * @param client
     * @param response
     */
    private void sendResponse(SocketChannel client, String response) {
        try {

<span class="nc" id="L484">            ByteBuffer responseBuffer = ByteBuffer.wrap(response.getBytes());</span>
<span class="nc" id="L485">            client.write(responseBuffer);</span>
<span class="nc" id="L486">        } catch(Exception error) {</span>
<span class="nc" id="L487">            System.out.println(&quot;Something went wrong while sending a message&quot;);</span>
<span class="nc" id="L488">        }</span>

<span class="nc" id="L490">    }</span>

    /**
     * Function to show everyone's cards to everyone
     * @return
     */
    public Pair showdown() {
        //showdown - send everyone's hands to everyone
<span class="nc" id="L498">        String answer = &quot;&quot;;</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">        for (Player player : playerMap.values()) {</span>
<span class="nc" id="L500">            answer += player.getName_() + &quot;: &quot; + player.getHand_().toString() + &quot;\n&quot;;</span>
<span class="nc" id="L501">        }</span>
<span class="nc" id="L502">        return new Pair(answer, true);</span>
    }

    /**
     * Function to trigger calculating the winning hand and grant points
     * @return
     */
    Player calculateRoundWinner() {
<span class="nc" id="L510">        int numberOfPlayersLeft = 0;</span>
<span class="nc" id="L511">        ArrayList&lt;Player&gt; playersLeft = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L512">        int pot = 0;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        for (Player player1 : playerMap.values()) {</span>
<span class="nc" id="L514">            player1.score = 0;</span>
<span class="nc" id="L515">            pot += player1.getBet_();</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            if (!player1.isFolded_()) {</span>
<span class="nc" id="L517">                numberOfPlayersLeft++;</span>
<span class="nc" id="L518">                playersLeft.add(player1);</span>
            } else {
                continue;
            }
<span class="nc" id="L522">        }</span>
<span class="nc" id="L523">        playersLeft.sort(new Comparator&lt;Player&gt;() {</span>
            @Override
            public int compare(Player player, Player t1) {
<span class="nc" id="L526">                return t1.getHand_().isBetterThan(player.getHand_());</span>
            }
        });

<span class="nc" id="L530">        int numberOfWinners = 1;</span>
<span class="nc" id="L531">        int winnerScore = playersLeft.get(0).score;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">        for (int i = 1; i &lt; numberOfPlayersLeft; i++) {</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">            if (playersLeft.get(i).getHand_().isBetterThan(playersLeft.get(0).getHand_())==0) {</span>
<span class="nc" id="L534">                numberOfWinners++;</span>
            } else {
                break;
            }
        }

<span class="nc" id="L540">        int moneyPerWinner = pot / numberOfWinners;</span>
<span class="nc" id="L541">        int moneyLeft = pot % numberOfWinners;</span>

<span class="nc bnc" id="L543" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfWinners; i++) {</span>
<span class="nc" id="L544">            playersLeft.get(i).setBalance_(playersLeft.get(i).getBalance_() + moneyPerWinner);</span>
<span class="nc" id="L545">            playersLeft.get(i).isWinner_ = true;</span>
        }
<span class="nc" id="L547">        return playersLeft.get(0);</span>
    }

    /*
    Player calculateRoundWinner() {
        int numberOfPlayersLeft = 0;
        ArrayList&lt;Player&gt; playersLeft = new ArrayList&lt;&gt;();
        int pot = 0;
        for (Player player1 : playerMap.values()) {
            player1.score = 0;
            pot += player1.getBet_();
            if (!player1.isFolded_()) {
                numberOfPlayersLeft++;
                playersLeft.add(player1);
            } else {
                continue;
            }
            for (Player player2 : playerMap.values()) {
                if (player1 != player2 &amp;&amp; !player2.isFolded_()) {
                    //ADDING 1 POINT FOR WINNING A COMPARISON
                    if (player1.getHand_().isBetterThan(player2.getHand_()) &gt; 0) {
                        player1.score++;
                    }
                }
            }
        }

        playersLeft.sort(Comparator.comparingInt(o -&gt; -o.score));

        int numberOfWinners = 1;
        int winnerScore = playersLeft.get(0).score;
        for (int i = 1; i &lt; numberOfPlayersLeft; i++) {
            if (playersLeft.get(i).score == winnerScore) {
                numberOfWinners++;
            } else {
                break;
            }
        }

        int moneyPerWinner = pot / numberOfWinners;
        int moneyLeft = pot % numberOfWinners;

        for (int i = 0; i &lt; numberOfWinners; i++) {
            playersLeft.get(i).setBalance_(playersLeft.get(i).getBalance_() + moneyPerWinner);
            playersLeft.get(i).isWinner_ = true;
        }
        return playersLeft.get(0);
    }

     */

    /**
     * Function checking for end of round of betting
     * @return
     */
    boolean isItEndOfBetting() {
<span class="nc" id="L603">        int numberOfUnfoldedPlayers = 0;</span>
<span class="nc" id="L604">        boolean everyPlayer = true;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        for (Player player : players_) {</span>
<span class="nc" id="L606">            System.out.println(player.getBet_());</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">            if (player.getBet_() != currentBet &amp;&amp; !player.isFolded_())</span>
<span class="nc" id="L608">                everyPlayer = false;</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">            if (!player.isFolded_()) {</span>
<span class="nc" id="L610">                numberOfUnfoldedPlayers++;</span>
            }
<span class="nc" id="L612">        }</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">        if (numberOfUnfoldedPlayers == 1) {</span>
<span class="nc" id="L614">            return true;</span>
        }
<span class="nc" id="L616">        return everyPlayer;</span>


    }


    /* -------------------------------------------------------------------------- */
    /*                                 Game States                                */
    /* -------------------------------------------------------------------------- */

    /**
     * Triggered at the start of the game
     */
    void startGame() {
<span class="nc" id="L630">        deck_.shuffle();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">        for (Player player : playerMap.values()) {</span>
<span class="nc" id="L632">            deck_.deal(player, 5);</span>
<span class="nc" id="L633">            player.setBet_(-1);</span>
<span class="nc" id="L634">        }</span>
<span class="nc" id="L635">        nextPlayer();</span>
<span class="nc" id="L636">        gameState = 1;</span>
<span class="nc" id="L637">    }</span>
    /**
     * Triggered at the end of first found of bets
     */
    boolean endFirstRoundBets() {
<span class="pc bpc" id="L642" title="3 of 4 branches missed.">        if (gameState != 1 || !isItEndOfBetting()) {</span>
<span class="fc" id="L643">            return false;</span>
        }

<span class="nc" id="L646">        gameState = 2;</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">        for (Player player : players_) {</span>
<span class="nc" id="L648">            player.setBet_(-1);</span>
<span class="nc" id="L649">        }</span>
<span class="nc" id="L650">        currentBet = 0;</span>
<span class="nc" id="L651">        currentPlayerIndex = 0;</span>

<span class="nc" id="L653">        return true;</span>
    }
    /**
     * Triggered at the end of exchange phase
     */
    boolean endOfStateWaitingForCardsChangePhase() {
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if (gameState != 2)</span>
<span class="nc" id="L660">            return false;</span>
<span class="nc" id="L661">        boolean everyPlayer = true;</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">        for (Player player : players_) {</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">            if (!player.wereTheHandsChanged_)</span>
<span class="nc" id="L664">                return false;</span>
<span class="nc" id="L665">        }</span>
<span class="nc" id="L666">        gameState = 3;</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">        for (Player player : players_) {</span>
<span class="nc" id="L668">            player.setBet_(-1);</span>
<span class="nc" id="L669">        }</span>

<span class="nc" id="L671">        currentBet = 0;</span>
<span class="nc" id="L672">        currentPlayerIndex = 0;</span>

<span class="nc" id="L674">        return true;</span>
    }
    /**
     * Triggered at the end of second round of bets
     */
    void endOfSecondRoundBets() {
<span class="nc bnc" id="L680" title="All 4 branches missed.">        if (gameState != 3 || !isItEndOfBetting())</span>
<span class="nc" id="L681">            return;</span>
<span class="nc" id="L682">        gameState = 4;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">        for (Player player : players_) {</span>
<span class="nc" id="L684">            player.setBet_(0);</span>
<span class="nc" id="L685">        }</span>
<span class="nc" id="L686">        currentBet = 0;</span>
<span class="nc" id="L687">        currentPlayerIndex = 0;</span>
<span class="nc" id="L688">        calculateRoundWinner();</span>
<span class="nc" id="L689">        showdown();</span>
<span class="nc" id="L690">    }</span>
    /**
     * Triggered at the very end of the round
     */
    void endOfStateGameOverStartNextRound() {
<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (gameState != 5) {</span>
<span class="nc" id="L696">            return;</span>
        }
<span class="nc" id="L698">        gameState = 0;</span>

<span class="nc bnc" id="L700" title="All 2 branches missed.">        for (Player player : players_) {</span>
<span class="nc" id="L701">            player.resetForNextRound();</span>
<span class="nc" id="L702">        }</span>
<span class="nc" id="L703">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>